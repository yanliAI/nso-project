<script setup lang="ts">
import { onMounted, reactive, ref } from 'vue';

import { Download, Search, Refresh, Plus } from '@element-plus/icons-vue';
import {
  ElButton,
  ElCol,
  ElForm,
  ElFormItem,
  ElInput,
  ElPagination,
  ElRow,
  ElSelect,
  ElMessage,
  ElTable,
  ElTableColumn,
} from 'element-plus';
import type { FormInstance, FormRules } from 'element-plus';
import {
  insertAppDomain,
  searchAppDomain,
  updateAppDomain,
  deleteAppDomain,
} from '#/api';

// 头部表单
const queryFormRef = ref();
const queryForm = reactive({});
const submitFormRef = ref();
const submitForm = reactive({});
const openInsertDialog = ref(false);
const openUpdateDialog = ref(false);

const StatusOptions = [
  {
    label: '正常',
    value: '1',
  },
  {
    label: '异常',
    value: '2',
  },
  {
    label: '掉线',
    value: '3',
  },
];
function getStatusLabel(code: string) {
  const status = StatusOptions.find((item) => item.value === code);
  return status ? status.label : code; // 如果找不到则显示原始code
}
// 表格
const data = reactive({
  tableData: [],
  pageInfo: {
    pageSize: 10,
    pageNo: 1,
    total: 0,
  },
});

onMounted(() => {
  queryData();
});

// 查询数据
async function queryData() {
  try {
    const res = await searchAppDomain({
      pageSize: data.pageInfo.pageSize,
      pageNo: data.pageInfo.pageNo,
      ...queryForm,
    });
    if (res) {
      data.tableData = res.list;
      data.pageInfo.total = res.total;
    }
  } catch (error) {
    console.error('查询数据失败:', error);
  }
}

// 重置查询
function reset() {
  queryFormRef.value?.resetFields();
  queryData();
}

// 新增数据
function insertData() {
  Object.assign(submitForm, {
    appDomainName: '',
    appDomainStatus: '',
    networkPartition: '',
    appDomainRemark: '',
  });
  // submitFormRef.value?.resetFields();
  openInsertDialog.value = true;
}

// 自定义验证规则
const formRules: FormRules = {
  appDomainName: [
    { required: true, message: '应用域名称未填写', trigger: 'blur' },
  ],
  appDomainStatus: [
    { required: true, message: '应用域状态未选中', trigger: 'change' },
  ],
  networkPartition: [
    { required: true, message: '网络分区未填写', trigger: 'blur' },
  ],
};

// 新增数据提交
async function handleSubmit() {
  if (!submitFormRef.value) return;
  try {
    const isValid = await submitFormRef.value.validate();
    if (!isValid) return;

    await insertAppDomain(submitForm);
    openInsertDialog.value = false;
    queryData();
    ElMessage.success('提交成功');
  } catch {
    // 这里不会执行，因为验证错误已被捕获
    console.log('提交失败');
  }
}

// 更新数据
function updateData(row: any) {
  Object.assign(submitForm, row);
  openUpdateDialog.value = true;
}

// 更新数据提交
async function handleUpdateSubmit() {
  if (!submitFormRef.value) return;
  try {
    const isValid = await submitFormRef.value.validate();
    if (!isValid) return;

    await updateAppDomain(submitForm);
    openUpdateDialog.value = false;
    queryData();
    ElMessage.success('提交成功');
  } catch {
    // 这里不会执行，因为验证错误已被捕获
    console.log('提交失败');
  }
}

// 删除数据
async function deleteData(row: any) {
  try {
    await deleteAppDomain(row);
    queryData();
    ElMessage.success('删除成功');
  } catch (error) {
    console.error('删除数据失败:', error);
  }
}

// 分页查询
function currentChange(val: any) {
  data.pageInfo.pageNo = val;
  queryData();
}

function handleSizeChange(val: number) {
  data.pageInfo.pageSize = val;
  queryData();
}
</script>
<template>
  <div>
    <div style="padding: 0 20px">
      <ElForm
        :inline="true"
        ref="queryFormRef"
        :model="queryForm"
        label-position="left"
      >
        <ElFormItem label="应用域名称:" prop="appDomainName">
          <ElInput v-model="queryForm.appDomainName" clearable />
        </ElFormItem>
        <ElFormItem label="应用域状态:" prop="appDomainStatus">
          <ElSelect
            v-model="queryForm.appDomainStatus"
            placeholder="请选择"
            style="width: 180px"
          >
            <el-option
              v-for="(item, index) in StatusOptions"
              :key="index"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </ElFormItem>
        <ElFormItem label="应用域说明:" prop="appDomainRemark">
          <ElInput v-model="queryForm.appDomainRemark" clearable />
        </ElFormItem>
        <ElFormItem style="width: auto">
          <ElButton type="primary" :icon="Plus" @click="insertData"
            >新增</ElButton
          >
          <ElButton type="primary" :icon="Search" @click="queryData"
            >查询</ElButton
          >
          <ElButton type="info" :icon="Refresh" @click="reset">重置</ElButton>
        </ElFormItem>
      </ElForm>
    </div>
    <div style="padding: 0 20px 10px 20px">
      <ElTable ref="tab" border stripe :data="data.tableData" height="710px">
        <ElTableColumn type="index" />
        <ElTableColumn type="selection" />
        <ElTableColumn
          prop="appDomainFlage"
          align="center"
          label="应用域标识"
        />
        <ElTableColumn prop="appDomainName" align="center" label="应用域名称" />
        <ElTableColumn
          prop="networkPartition"
          align="center"
          label="网络分区"
        />
        <ElTableColumn prop="appDomainStatus" label="应用域状态" align="center">
          <template #default="scope">
            <div>{{ getStatusLabel(scope.row.appDomainStatus) }}</div>
          </template>
        </ElTableColumn>
        <ElTableColumn
          prop="appDomainRemark"
          align="center"
          label="应用域说明"
        />
        <ElTableColumn prop="updaterId" align="center" label="最后修改人" />
        <ElTableColumn prop="updateTime" align="center" label="最后修改时间" />

        <ElTableColumn label="操作" align="center">
          <template #default="scope">
            <el-button type="primary" link @click="updateData(scope.row)"
              >修改</el-button
            >
            <el-button type="danger" link @click="deleteData(scope.row)"
              >删除</el-button
            >
          </template>
        </ElTableColumn>
      </ElTable>
    </div>
    <div style="padding-left: 20px; display: flex">
      <ElPagination
        v-model:current-page="data.pageInfo.pageNo"
        v-model:page-size="data.pageInfo.pageSize"
        :total="data.pageInfo.total"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="currentChange"
      />
    </div>
    <ElDialog
      v-model="openInsertDialog"
      title="新增应用域"
      width="500"
      class="system-detail-dialog"
    >
      <ElForm
        ref="submitFormRef"
        :model="submitForm"
        :rules="formRules"
        label-width="auto"
        style="padding-left: 20px"
      >
        <ElFormItem
          label="应用域名称:"
          prop="appDomainName"
          style="width: 400px"
          required
        >
          <ElInput
            v-model="submitForm.appDomainName"
            placeholder="请输入"
            clearable
            :maxlength="50"
          />
        </ElFormItem>

        <ElFormItem
          label="应用域状态:"
          prop="appDomainStatus"
          style="width: 400px"
          required
        >
          <ElSelect v-model="submitForm.appDomainStatus" placeholder="请选择">
            <el-option
              v-for="(item, index) in StatusOptions"
              :key="index"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </ElFormItem>
        <ElFormItem
          label="网络分区:"
          prop="networkPartition"
          style="width: 400px"
          required
        >
          <ElSelect
            v-model="submitForm.networkPartition"
            placeholder="请选择"
            required
          >
            <el-option label="Ⅳ区" value="Ⅳ区" />
            <el-option label="Ⅴ区" value="Ⅴ区" />
          </ElSelect>
        </ElFormItem>
        <ElFormItem
          label="应用域说明:"
          prop="appDomainRemark"
          style="width: 400px"
        >
          <ElInput
            v-model="submitForm.appDomainRemark"
            placeholder="请输入"
            clearable
            :rows="2"
            type="textarea"
            :maxlength="500"
          />
        </ElFormItem>
      </ElForm>
      <div style="display: flex; margin-right: 10px">
        <div style="margin-top: 10px; margin-left: auto">
          <ElButton type="primary" @click="handleSubmit">确定</ElButton>
          <ElButton @click="openInsertDialog = false">取消</ElButton>
        </div>
      </div>
    </ElDialog>
    <ElDialog
      v-model="openUpdateDialog"
      @close="cancel"
      title="更新应用域"
      width="500"
      class="system-detail-dialog"
    >
      <ElForm
        ref="submitFormRef"
        :model="submitForm"
        :rules="formRules"
        label-width="auto"
        style="padding-left: 20px"
      >
        <ElFormItem
          label="应用域名称:"
          prop="appDomainName"
          style="width: 400px"
          required
        >
          <ElInput
            v-model="submitForm.appDomainName"
            placeholder="请输入"
            clearable
            :maxlength="50"
          />
        </ElFormItem>
        <ElFormItem
          label="应用域状态:"
          prop="appDomainStatus"
          style="width: 400px"
          required
        >
          <ElSelect v-model="submitForm.appDomainStatus" placeholder="请选择">
            <el-option
              v-for="(item, index) in StatusOptions"
              :key="index"
              :label="item.label"
              :value="item.value"
            />
          </ElSelect>
        </ElFormItem>
        <ElFormItem
          label="网络分区:"
          prop="networkPartition"
          style="width: 400px"
          required
        >
          <ElSelect
            v-model="submitForm.networkPartition"
            placeholder="请选择"
            required
          >
            <el-option label="Ⅳ区" value="Ⅳ区" />
            <el-option label="Ⅴ区" value="Ⅴ区" />
          </ElSelect>
        </ElFormItem>
        <ElFormItem
          label="应用域说明:"
          prop="appDomainRemark"
          style="width: 400px"
        >
          <ElInput
            v-model="submitForm.appDomainRemark"
            placeholder="请输入"
            clearable
            :rows="2"
            type="textarea"
            :maxlength="500"
          />
        </ElFormItem>
      </ElForm>
      <div style="display: flex; margin-right: 10px">
        <div style="margin-top: 10px; margin-left: auto">
          <ElButton type="primary" @click="handleUpdateSubmit">确定</ElButton>
          <ElButton @click="openUpdateDialog = false">取消</ElButton>
        </div>
      </div>
    </ElDialog>
  </div>
</template>
<style lang="less" scoped>
// :deep(.el-form-item) {
//   width: 270px;
//   .el-form-item__content {
//     display: flex;
//     justify-content: flex-end;
//   }
//   .el-form-item__label {
//     width: 100px;
//     text-align: right;
//     font-size: 14px;
//     font-weight: 500;
//     // line-height: 32px;
//     color: #515a6e;
//   }
// }
</style>
