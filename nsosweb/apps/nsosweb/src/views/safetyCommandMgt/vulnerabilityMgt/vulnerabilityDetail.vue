<template>
  <div style="padding: 0px 20px 0">
    <el-form
      ref="formRef"
      :inline="true"
      :model="formData"
      :rules="rules"
      label-position="right"
      label-width="auto"
      :disabled="disabledValue"
    >
      <el-row :gutter="30">
        <el-col :span="8">
          <el-form-item label="漏洞名称：" prop="vulnerabilityName">
            <el-input
              v-model="formData.vulnerabilityName"
              clearable
              style="width: 100%"
            />
          </el-form-item>
        </el-col>
        <!-- <el-col :span="8">
          <el-form-item label="情报来源：" prop="source">
            <el-input v-model="formData.source" clearable style="width: 100%" />
          </el-form-item>
        </el-col> -->

        <el-col :span="8">
          <el-form-item label="漏洞发现时间：" prop="discoveryDate">
            <el-date-picker
              v-model="formData.discoveryDate"
              type="date"
              placeholder="请选择"
              format="YYYY-MM-DD"
              value-format="YYYY-MM-DD HH:mm:ss"
              style="width: 100%"
              :disabled-date="disabledDate"
            />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="所属系统：" prop="applicationSystemName">
            <el-select
              v-model="formData.applicationSystemName"
              placeholder="请选择"
              clearable
              filterable
            >
              <el-option
                v-for="item in systemList"
                :key="item.value"
                :label="item.name"
                :value="item.name"
              ></el-option>
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="30">
        <el-col :span="24">
          <el-form-item label="IPV4：" prop="ipv4">
            <el-input
              v-model="formData.ipv4"
              placeholder='IP或IP段，如 192.168.1.1 或 192.168.1.1~32。用","分割'
              clearable
              style="width: 100%"
            >
            </el-input>
          </el-form-item>
        </el-col>
        <el-col :span="24">
          <el-form-item label="IPV6：" prop="ipv6">
            <el-input
              v-model="formData.ipv6"
              placeholder='IP或IP段，如 2001::8a2e:370:7334 或 2001::8a2e:370:30~50。用","分割'
              clearable
              style="width: 100%"
            >
            </el-input>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="30">
        <el-col :span="8">
          <el-form-item label="漏洞类型：" prop="vulnerabilityType">
            <el-input
              v-model="formData.vulnerabilityType"
              clearable
              style="width: 100%"
            />
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="风险等级：" prop="riskLevel">
            <el-select
              v-model="formData.riskLevel"
              clearable
              style="width: 100%"
            >
              <el-option label="高危" value="高危"></el-option>
              <el-option label="中危" value="中危"></el-option>
              <el-option label="低危" value="低危"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="处置状态：" prop="handlingStatus">
            <el-select
              v-model="handleStatus"
              clearable
              style="width: 100%"
              disabled
            >
              <el-option label="未处置" value="0"></el-option>
              <el-option label="已研判-无需处置" value="1"></el-option>
              <el-option label="待签收" value="3"></el-option>
              <el-option label="待复令" value="4"></el-option>
              <el-option label="待复核" value="5"></el-option>
              <el-option label="已闭环" value="6"></el-option>
              <el-option label="已作废" value="7"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item label="漏洞描述：" prop="description">
        <el-input
          v-model="formData.description"
          clearable
          :rows="4"
          type="textarea"
          style="width: 100%"
        />
      </el-form-item>
    </el-form>
    <div class="flex" style="justify-content: flex-end">
      <el-button @click="emit('closeDialog')">{{
        disabledValue ? '关闭' : '取消'
      }}</el-button>
      <el-button type="primary" @click="validateForm" v-if="!disabledValue"
        >保存</el-button
      >
    </div>
  </div>
</template>

<script lang="ts" setup>
import {
  ElRow,
  ElCol,
  ElFormItem,
  ElForm,
  ElInput,
  ElSelect,
  ElOption,
  ElDialog,
  ElMessage,
  ElMessageBox,
  ElText,
  ElLink,
  ElTag,
} from 'element-plus';
import {
  Search,
  Download,
  Monitor,
  CircleCheck,
} from '@element-plus/icons-vue';
import { ref, reactive, computed, onMounted } from 'vue';
import {
  getVulnerabilityInfoDetailApi,
  addVulnerabilityInfoDataApi,
  querySystemListApi,
} from '#/api';

defineOptions({
  name: 'VulnerabilityDetail',
});
const detailId = defineModel('detailId');
const disabledValue = defineModel('disabled');
const emit = defineEmits(['closeDialog']);
const formRef = ref();
const formData = ref({});
const systemList = ref([]);

const handleStatus = computed(() => {
  if (
    formData.value.handlingStatus == 0 ||
    formData.value.handlingStatus == 1
  ) {
    return formData.value.handlingStatus;
  }
  console.log('commandStatus=', formData.value.commandStatus);
  return formData.value.commandStatus;
});

// IP验证正则
const validateIPv4 = (ip) => {
  // 去除前后空格
  ip = ip.trim();
  if (!ip) return false;
  // 简单IPV4验证正则
  const ipRegex =
    /^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)(\~(25[0-5]|2[0-4]\d|[01]?\d\d?))?$/;

  // 校验IP或IP段
  const result = ipRegex.test(ip);
  if (!result) {
    return false;
  }

  const parts = ip.split('~');
  // 如果没有CIDR部分，视为有效
  if (parts.length === 1) {
    return true;
  }
  const ipParts = parts[0].split('.').map(Number);
  const lastIpPart = ipParts[3];
  const cidr = parseInt(parts[1], 10);

  // 检查CIDR是否大于最后一个IP段
  if (cidr < lastIpPart) {
    // return {
    //   isValid: false,
    //   message: `CIDR值(${cidr})必须大于最后一个IP段的值(${lastIpPart})`,
    // };
    return false;
  }
  return true;
};

// IPv6 校验函数
const validateIPv6 = (ip) => {
  // 去除前后空格
  ip = ip.trim();
  if (!ip) return false;
  // IPv6 正则表达式（支持完整格式和压缩格式）
  const ipv6Regex =
    /^([\da-fA-F]{1,4}:){6}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^::([\da-fA-F]{1,4}:){0,4}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:):([\da-fA-F]{1,4}:){0,3}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){2}:([\da-fA-F]{1,4}:){0,2}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){3}:([\da-fA-F]{1,4}:){0,1}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){4}:((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){7}[\da-fA-F]{1,4}$|^:((:[\da-fA-F]{1,4}){1,6}|:)$|^[\da-fA-F]{1,4}:((:[\da-fA-F]{1,4}){1,5}|:)$|^([\da-fA-F]{1,4}:){2}((:[\da-fA-F]{1,4}){1,4}|:)$|^([\da-fA-F]{1,4}:){3}((:[\da-fA-F]{1,4}){1,3}|:)$|^([\da-fA-F]{1,4}:){4}((:[\da-fA-F]{1,4}){1,2}|:)$|^([\da-fA-F]{1,4}:){5}:([\da-fA-F]{1,4})?$|^([\da-fA-F]{1,4}:){6}:$/;

  // IPv6 带 CIDR 的正则表达式
  const ipv6WithCidrRegex =
    /^(((([\da-fA-F]{1,4}:){6}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(::([\da-fA-F]{1,4}:){0,4}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(([\da-fA-F]{1,4}:):([\da-fA-F]{1,4}:){0,3}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(([\da-fA-F]{1,4}:){2}:([\da-fA-F]{1,4}:){0,2}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(([\da-fA-F]{1,4}:){3}:([\da-fA-F]{1,4}:){0,1}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(([\da-fA-F]{1,4}:){4}:((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?))|(([\da-fA-F]{1,4}:){7}[\da-fA-F]{1,4})|(:((:[\da-fA-F]{1,4}){1,6}|:))|([\da-fA-F]{1,4}:((:[\da-fA-F]{1,4}){1,5}|:))|(([\da-fA-F]{1,4}:){2}((:[\da-fA-F]{1,4}){1,4}|:))|(([\da-fA-F]{1,4}:){3}((:[\da-fA-F]{1,4}){1,3}|:))|(([\da-fA-F]{1,4}:){4}((:[\da-fA-F]{1,4}){1,2}|:))|(([\da-fA-F]{1,4}:){5}:([\da-fA-F]{1,4})?)|(([\da-fA-F]{1,4}:){6}:))~([\da-fA-F]{1,4}))$/;
  // 先检查基本格式
  const basicCheck = ipv6Regex.test(ip) || ipv6WithCidrRegex.test(ip);
  if (!basicCheck) {
    return false;
  }

  // 检查 CIDR 部分
  const parts = ip.split('~');
  if (parts.length === 1) {
    return true; // 没有 CIDR 部分，直接返回有效
  }

  // const cidr = parseInt(parts[1], 10);

  // // IPv6 的 CIDR 范围是 0-128
  // if (cidr < 0 || cidr > 128) {
  //   return false;
  //   // 也可以返回更详细的错误信息
  //   // return {
  //   //   isValid: false,
  //   //   message: `IPv6 CIDR值必须在0-128之间(当前值: ${cidr})`
  //   // };
  // }

  return true;
};

const validateIpv4Field = () => {
  let ipStr = formData.value.ipv4;
  let ipv4List = [];
  if (ipStr) {
    // 判断是否有逗号
    if (ipStr.includes(',')) {
      // 以逗号分割并校验每个IP
      const ipList = ipStr.split(',');
      for (const ip of ipList) {
        if (!ip.trim()) {
          continue;
        }
        const isValid = validateIPv4(ip);
        if (!isValid) {
          ElMessage.error(`"${ip.trim()}" 不是有效的IPV4地址或地址段`);
          return null; // 这里可以直接退出整个函数
        }
        ipv4List.push(ip.trim());
      }
    } else {
      // 单个IP校验
      const isValid = validateIPv4(ipStr);
      if (!isValid) {
        ElMessage.error('请输入有效的IPV4或IPV4段地址');
        return null;
      }
      ipv4List.push(ipStr);
    }
    return ipv4List;
  }
  return null;
};

const validateIpv6Field = () => {
  let ipStr = formData.value.ipv6;
  let ipv6List = [];
  if (ipStr) {
    // 判断是否有逗号
    if (ipStr.includes(',')) {
      // 以逗号分割并校验每个IP
      const ipList = ipStr.split(',');
      for (const ip of ipList) {
        if (!ip.trim()) {
          continue;
        }
        const isValid = validateIPv6(ip);
        if (!isValid) {
          ElMessage.error(`"${ip.trim()}" 不是有效的IPV6地址或地址段`);
          return null; // 这里可以直接退出整个函数
        }
        ipv6List.push(ip.trim());
      }
    } else {
      // 单个IP校验
      const isValid = validateIPv6(ipStr);
      if (!isValid) {
        ElMessage.error('请输入有效的IPV6或IPV6段地址');
        return null;
      }
      ipv6List.push(ipStr);
    }
    return ipv6List;
  }
  return null;
};

const validateForm = async () => {
  if (!formRef.value) return false;
  formRef.value.validate(async (valid, fields) => {
    if (valid) {
      let ipv4List = validateIpv4Field();
      if (formData.value.ipv4 && !ipv4List) {
        return;
      }
      let ipv6List = validateIpv6Field();
      if (formData.value.ipv6 && !ipv6List) {
        return;
      }
      let params = { ...formData.value };
      if (formData.value.applicationSystemName) {
        let system = systemList.value.find(
          (item) => item.name == formData.value.applicationSystemName,
        );
        if (system) {
          params.graphElementId = system?.value;
        }
      }
      if (detailId.value) {
        params.id = detailId.value;
      }
      try {
        let result = await addVulnerabilityInfoDataApi(params);
        if (result) {
          ElMessage.success('保存成功');
          emit('closeDialog', { refresh: true });
        }
      } catch {}
    } else {
      console.log('fields==', fields);
      ElMessage.warning('请输入必填项！');
    }
  });
};

const getDetailInfo = async () => {
  if (!detailId.value) {
    formData.value.handlingStatus = '0';
    return;
  }
  try {
    formData.value = await getVulnerabilityInfoDetailApi(detailId.value);
  } catch {}
};

const disabledDate = (time) => {
  return time.getTime() > Date.now();
};

const rules = reactive({
  vulnerabilityName: [{ required: true, message: '请输入漏洞名称' }],
  discoveryDate: [{ required: true, message: '请选择发现时间' }],
});
defineExpose({
  formData,
  validateForm,
});
onMounted(async () => {
  getDetailInfo();
  try {
    const result = await querySystemListApi();
    systemList.value = result.map((item) => {
      return {
        name: item.applicationSystemName,
        value: item.graphElementId,
      };
    });
  } catch {}
});
</script>

<style scoped>
::v-deep .el-form-item {
  width: 100%;
}
</style>
